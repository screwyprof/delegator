---
description: "Testing strategy for the delegation service using TDD/ATDD approach"
globs: **/*.go
alwaysApply: false
---

# Testing Strategy

## TDD/ATDD Workflow for Two-Service Architecture

### 1. Start with Acceptance Tests (ATDD)
**Test the user-facing contract via Web API**
- **Why Web API**: Users interact with the HTTP endpoint, not the scraper directly
- **Use build tags**: `//go:build acceptance` for expensive tests
- **Test data**: Use controlled test data in database (not live scraping)
- **Start simple**: First test just checks call succeeds and returns non-nil

### TDD Cycle Discipline
- **RED phase**: Test should fail with meaningful error message
- **GREEN phase**: Simplest implementation to pass test
- **REFACTOR**: Improve code while keeping tests passing
- **Meaningful assertions**: Provide helpful debugging information in test failures

### CRITICAL: What's Allowed in Each TDD Phase
**RED Phase**:
- ✅ Write new failing test
- ✅ Write meaningful assertions
- ❌ No implementation changes

**GREEN Phase**:
- ✅ Write minimal code to pass test
- ✅ Implementation can be ugly/simple
- ❌ No new tests, no test changes

**REFACTOR Phase**:
- ✅ Improve implementation quality (error handling, naming, structure)
- ✅ Improve test code quality (extract helpers, better names, remove duplication)
- ✅ Keep test behavior unchanged - same assertions, same coverage
- ❌ NEVER add new test cases or scenarios
- ❌ NEVER change what's being tested or expected outcomes
- ❌ NEVER add new requirements or features

**New features/error cases = new TDD cycles, not refactoring**

### Test Structure (Arrange/Act/Assert)
- **Arrange**: Set up test data, mocks, and initial state
- **Act**: Execute the behavior being tested
- **Assert**: Verify the expected outcomes with helpful error messages

## Test Helper Design

### Intent-Revealing Helper Names
- **Function names should clearly communicate their purpose**
  - `newURLTrackingServer()` - captures request URLs for parameter verification
  - `assertAPIError()` - verifies API client errors (not domain errors)
  - `newServerWithStatusCode(500)` - creates server that returns specific HTTP status
  - `assertParsedDelegationsMatch()` - compares expected vs actual parsed data

### Remove Redundant Comments
- **Don't comment test helpers where names are self-explanatory**
  - No comments needed for: `newServerWithInvalidJSON()`, `assertURLContainsParam()`, `createTestDelegation()`
  - Only comment when implementation is complex or non-obvious
  - Remove section headers like "Test server helpers" - group by function name patterns instead

### Test Data and Assertions
- **Use `assert.Equal()` with expected data structures instead of field-by-field assertions**
  - Create expected delegation structs and compare entire arrays
  - Reuse the same test data for both server responses and expected results
  - Don't duplicate data creation with different variable names (`testDelegations` vs `expectedDelegations`)

### Context-Appropriate Naming in Tests
- **Don't prefix test variables with "test" when context is obvious**
  - Use `httpTimeout` not `testTimeout` in acceptance tests
  - Use `limit` not `testLimit` when only used in test context
  - Use `offset` not `stableOffset` when there's only one offset value

## Test Organization
- **All tests parallel**: Use `t.Parallel()` by default
- **Verbose output**: Default to `-v` flag to see progress
- **Race detection**: Always use `-race` flag
- **Build tags**: Use `//go:build acceptance` to separate expensive tests
- **httptest = unit tests**: Tests using `httptest.NewServer()` are unit tests, not integration tests

## Key Principles
- **Acceptance tests via Web API**: Test user experience, not internal scraper behavior
- **Build tags separate expensive tests**: Use `//go:build acceptance`
- **Meaningful test assertions**: Provide helpful debugging information in test failures
- **Workspace-aware testing**: Must test all modules: `./... ./pkg/... ./scraper/... ./web/...`
