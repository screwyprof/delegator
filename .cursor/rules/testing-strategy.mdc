---
description: "Testing strategy for the delegation service using TDD/ATDD approach"
globs: **/*.go
alwaysApply: false
---

# Testing Strategy

## TDD/ATDD Workflow for Two-Service Architecture

### 1. Start with Acceptance Tests (ATDD)
**Test the user-facing contract via Web API**
- **Why Web API**: Users interact with the HTTP endpoint, not the scraper directly
- **Use build tags**: `//go:build acceptance` for expensive tests
- **Test data**: Use controlled test data in database (not live scraping)
- **Start simple**: First test just checks call succeeds and returns non-nil

### TDD Cycle Discipline
- **RED phase**: Test should fail with meaningful error message
- **GREEN phase**: Simplest implementation to pass test
- **REFACTOR**: Improve code while keeping tests passing
- **Meaningful assertions**: Provide helpful debugging information in test failures

### CRITICAL: What's Allowed in Each TDD Phase
**RED Phase**:
- ✅ Write new failing test
- ✅ Write meaningful assertions
- ❌ No implementation changes

**GREEN Phase**:
- ✅ Write minimal code to pass test
- ✅ Implementation can be ugly/simple
- ❌ No new tests, no test changes

**REFACTOR Phase**:
- ✅ Improve implementation quality (error handling, naming, structure)
- ✅ Improve test code quality (extract helpers, better names, remove duplication)
- ✅ Keep test behavior unchanged - same assertions, same coverage
- ❌ NEVER add new test cases or scenarios
- ❌ NEVER change what's being tested or expected outcomes
- ❌ NEVER add new requirements or features

**New features/error cases = new TDD cycles, not refactoring**

### Test Structure (Arrange/Act/Assert)
- **Arrange**: Set up test data, mocks, and initial state
- **Act**: Execute the behavior being tested
- **Assert**: Verify the expected outcomes with helpful error messages

## Test Organization
- **All tests parallel**: Use `t.Parallel()` by default
- **Verbose output**: Default to `-v` flag to see progress
- **Race detection**: Always use `-race` flag
- **Build tags**: Use `//go:build acceptance` to separate expensive tests
- **httptest = unit tests**: Tests using `httptest.NewServer()` are unit tests, not integration tests

## Key Principles
- **Acceptance tests via Web API**: Test user experience, not internal scraper behavior
- **Build tags separate expensive tests**: Use `//go:build acceptance`
- **Meaningful test assertions**: Provide helpful debugging information in test failures
- **Workspace-aware testing**: Must test all modules: `./... ./pkg/... ./scraper/... ./web/...`
