---
description: "Reliability and resilience patterns for external API integration and fault tolerance. Use when implementing error handling, retry strategies, or building fault-tolerant systems."
globs: 
alwaysApply: false
---

# Reliability Guidelines

## Essential Patterns (Implement First)

### Tzkt API Integration Reliability
- **HTTP Client Configuration**:
  - **Dial Timeout**: 10 seconds to establish connection
  - **Request Timeout**: 30 seconds total per request
  - **Response Header Timeout**: 10 seconds to receive response headers
  - **Keep-Alive**: 30 seconds to reuse connections
  - **Max Idle Connections**: 10 connections per host
- **Retry Strategy**: Exponential backoff with progression: 1s, 2s, 4s, 8s, 16s, then fail
- **Rate Limiting**: Respect 10 requests per second limit (verify in Tzkt docs)
- **Error Handling**: Log failures with context, continue polling despite temporary failures

### Database Reliability
- **Connection Pooling**: Configure max connections, idle timeouts, connection lifetimes
- **Connection Retry**: Implement retry logic for database connection failures
- **Transaction Safety**: Proper rollback on errors, ensure data consistency
- **Query Timeouts**: 10 seconds for reads, 30 seconds for writes

### Basic Error Handling
- **Structured Logging**: Log errors with context (request ID, delegation ID, timestamp)
- **Graceful Degradation**: Continue core operations when non-critical features fail
- **Error Propagation**: Return meaningful errors to callers with proper context

## Production Enhancements (Add Later)

### Advanced Resilience
- **Circuit Breakers**: Stop calling consistently failing external services
- **Health Checks**: Implement `/health` and `/ready` endpoints for Kubernetes
- **Metrics Collection**: Track success rates, response times, error rates
- **Alerting**: Set up monitoring and alerting for critical failure scenarios

### API Protection
- **HTTP Server Configuration**:
  - **Read Timeout**: 30 seconds for reading request body
  - **Write Timeout**: 30 seconds for writing response
  - **Idle Timeout**: 60 seconds for keep-alive connections
  - **Header Timeout**: 10 seconds for reading request headers
- **Rate Limiting (Inbound)**: Protect Web API from abuse and excessive load
- **Input Validation**: Comprehensive validation of all user inputs
- **Authentication**: JWT or API key authentication for production deployment

### Observability
- **Distributed Tracing**: Track requests across services
- **Performance Profiling**: pprof endpoints for performance analysis
- **Custom Metrics**: Business-specific metrics (delegations processed, backfill progress)
- **Error Tracking**: Comprehensive error aggregation and analysis

## Implementation Guidelines

### Phase 1: Core Reliability (Essential)
1. **Tzkt API client** with retry logic and timeouts
2. **Database connection** management with pooling
3. **Basic error handling** with structured logging
4. **Graceful shutdown** handling for both services

### Phase 2: Enhanced Reliability (Production)
1. **Circuit breakers** for external API calls
2. **Health check endpoints** for monitoring
3. **Rate limiting** for API protection
4. **Advanced monitoring** and alerting

### Phase 3: Full Observability (Enterprise)
1. **Distributed tracing** across services
2. **Custom metrics** and dashboards
3. **Performance profiling** and optimization
4. **Comprehensive alerting** and runbooks

## Decision Guidelines for AI

### When to Add Reliability Features
- **Start with essential patterns**: Retry logic, timeouts, connection pooling
- **Add monitoring incrementally**: Basic logging first, then metrics and alerting
- **Profile before optimizing**: Identify actual reliability bottlenecks

### Error Handling Strategy
- **Fail fast for user errors**: Invalid parameters, malformed requests
- **Retry for transient failures**: Network issues, temporary API unavailability
- **Log and continue for non-critical errors**: Metrics collection failures, optional features
- **Graceful degradation**: Core functionality works even when auxiliary features fail
