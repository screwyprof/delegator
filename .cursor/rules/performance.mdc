---
description: "Performance optimization guidelines for improving speed, memory usage, and efficiency. Use when optimizing code performance, addressing bottlenecks, or implementing efficient algorithms."
globs: 
alwaysApply: false
---


# Performance Guidelines

## Delegation Service Performance Targets

### Scraper Service Performance
- **Polling Interval**: 30 seconds for new delegations (balances API load vs real-time updates)
- **Batch Processing**: Process 1000 delegations per batch to limit memory usage
- **Backfill Rate**: Target 10,000 delegations per minute for historical data
- **API Request Timeout**: 30 seconds per Tzkt API call
- **Retry Backoff**: 1s, 2s, 4s, 8s, 16s progression for failed requests

### Web API Performance
- **Response Time Target**: < 500ms for paginated queries
- **Pagination Size**: Fixed at 50 items per page (optimal for user experience)
- **Query Timeout**: 10 seconds maximum for database queries
- **Memory Limit**: < 100MB per request processing

## Database Performance Strategy

### Required Indexes
- **Primary Query Index**: `(timestamp DESC, id)` for pagination
- **Year Filter Index**: `(EXTRACT(year FROM timestamp))` for year-based queries
- **Delegator Lookup**: `(delegator, timestamp DESC)` for user-specific queries
- **Level Tracking**: `(level)` for scraper checkpoint queries

### Connection Management
- **Connection Pool**: 10 connections max, 5 min idle, 30 min max lifetime
- **Pool Mode**: Transaction-mode pooling (connections assigned per query, returned after completion)
- **Query Timeout**: 10 seconds for read operations, 30 seconds for writes
- **Transaction Timeout**: 60 seconds maximum for backfill operations
- **Prepared Statements**: Share prepared statements across pooled connections for efficiency

## Memory Management for Polling Services

### Batch Processing Strategy
- **Delegation Batches**: Process 1000 delegations at a time
- **Memory Reuse**: Use sync.Pool for HTTP request/response objects
- **Streaming**: Process Tzkt API responses as streams, not full JSON loads
- **Garbage Collection**: Force GC after large batch processing

### Resource Cleanup
- **HTTP Connections**: Always close response bodies with defer
- **Database Connections**: Return to pool immediately after use
- **Contexts**: Cancel contexts when operations complete or timeout

## API Response Optimization

### JSON Serialization
- **Struct Tags**: Use json struct tags, avoid reflection-based serialization
- **Response Pooling**: Reuse response objects for similar query patterns
- **Compression**: Enable gzip compression for responses > 1KB

### Concurrent Request Handling
- **Goroutine Limit**: Use worker pools to limit concurrent request processing
- **Request Timeout**: 30 seconds total request timeout including DB queries
- **Connection Limits**: Respect database connection pool limits

## Performance Monitoring Points

### Scraper Metrics
- **Polling Success Rate**: Track successful vs failed Tzkt API calls
- **Processing Rate**: Delegations processed per minute
- **Backfill Progress**: Percentage of historical data processed
- **Memory Usage**: Peak memory per batch processing cycle

### API Metrics
- **Response Time**: P95 response time for /xtz/delegations endpoint
- **Throughput**: Requests per second capacity
- **Error Rate**: Failed requests as percentage of total
- **Database Query Time**: Average query execution time

## Decision Guidelines for AI

### When to Optimize
- **Implement basic performance patterns first**: Indexes, connection pooling, timeouts
- **Profile before optimizing**: Don't guess at performance bottlenecks
- **Focus on user-facing performance**: API response times over internal metrics

### Performance vs Simplicity Trade-offs
- **Prefer simple solutions**: Use standard library HTTP server over frameworks
- **Optimize hot paths**: Database queries and API endpoints get priority
- **Avoid premature optimization**: Focus on correctness first, then performance
